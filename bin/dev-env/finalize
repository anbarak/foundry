#!/usr/bin/env bash

# -----------------------------------------------------------------------------
# ğŸ§  Setting up Oh My Zsh + Powerlevel10k + Plugins
# -----------------------------------------------------------------------------
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "âš™ï¸  Setting up Oh My Zsh + Plugins"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if [[ -d "$HOME/.oh-my-zsh" ]]; then
  echo "âœ… Oh My Zsh already installed. Skipping..."
else
  echo "âš™ï¸ Installing Oh My Zsh..."
  sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
fi

ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"

[[ -d "$ZSH_CUSTOM/themes/powerlevel10k" ]] || \
  git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "$ZSH_CUSTOM/themes/powerlevel10k"

[[ -d "$ZSH_CUSTOM/plugins/zsh-autosuggestions" ]] || \
  git clone https://github.com/zsh-users/zsh-autosuggestions "$ZSH_CUSTOM/plugins/zsh-autosuggestions"

[[ -d "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting" ]] || \
  git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting"

echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "ğŸ§ª Setting up TPM + Completions"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if [[ -d "$HOME/.tmux/plugins/tpm" ]]; then
  echo "âœ… TPM already installed"
else
  git clone https://github.com/tmux-plugins/tpm "$HOME/.tmux/plugins/tpm"
fi
mkdir -p ~/.tmux/resurrect
curl -fsSL https://raw.githubusercontent.com/git/git/master/contrib/completion/git-completion.zsh \
  -o ~/.zsh/completions/_git
curl -fLo ~/.oh-my-zsh/plugins/docker/_docker \
  https://raw.githubusercontent.com/docker/cli/master/contrib/completion/zsh/_docker

# -----------------------------------------------------------------------------
# ğŸ“¦ Install Vim Plugins
# -----------------------------------------------------------------------------
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "ğŸ“¦ Installing vim plugins"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
     https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
vim +PlugInstall +qall

# -----------------------------------------------------------------------------
# ğŸ› ï¸  Ensure Secrets Cron Job
# -----------------------------------------------------------------------------
# Ensure secrets backup cron job exists
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "ğŸ› ï¸ Ensuring secrets backup cron job is set"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
"$HOME/bin/secrets/ensure-cron"

# -----------------------------------------------------------------------------
# ğŸ“š Kubectl Krew Plugins
# -----------------------------------------------------------------------------
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "ğŸ“š Setting up Kubectl plugins via Krew"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
# Install krew if not installed
if ! kubectl krew version &>/dev/null; then
  (
    cd "$(mktemp -d)" &&
    OS="$(uname | tr '[:upper:]' '[:lower:]')" &&
    ARCH="$(uname -m | sed -e 's/x86_64/amd64/' -e 's/aarch64$/arm64/')" &&
    KREW="krew-${OS}_${ARCH}" &&
    curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/${KREW}.tar.gz" &&
    tar zxvf "${KREW}.tar.gz" &&
    ./"${KREW}" install krew
  )
else
  echo "âœ… krew already installed"
fi

# Define list of desired plugins
KREW_PLUGINS=(ctx ns tree whoami neat ktop)

# Install missing plugins only
for plugin in "${KREW_PLUGINS[@]}"; do
  if ! kubectl krew list | grep -q "^${plugin}$"; then
    echo "ğŸ”Œ Installing kubectl plugin: $plugin"
    kubectl krew install "$plugin"
  else
    echo "âœ… Plugin already installed: $plugin"
  fi
done

# Optional MySQL configuration
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ˜ Optional: Configure MySQL Credentials
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "ğŸ˜ Optional: Configuring MySQL"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

if gum confirm "ğŸ”” Do you want to configure a MySQL login path now?"; then
  db_choice=$(gum choose \
    "Centerfield - Production Writer (datalot_prod_writer_r5m2_auroramysql_useast1a)" \
    "Other (manual entry)")

  case "$db_choice" in
    "Centerfield - Production Writer (datalot_prod_writer_r5m2_auroramysql_useast1a)")
      LOGIN_PATH="datalot_prod_writer_r5m2_auroramysql_useast1a"
      MYSQL_HOST="encrypted-r5m2.c6uqsvavlrra.us-east-1.rds.amazonaws.com"
      MYSQL_USER="dlroot"
      MYSQL_PORT="3306"
      ;;
    "Other (manual entry)")
      echo "ğŸ—‚ï¸  Enter MySQL login-path name (e.g., 'default'):"
      read -r LOGIN_PATH
      echo "ğŸ‘¤ Enter MySQL user:"
      read -r MYSQL_USER
      echo "ğŸŒ Enter MySQL host:"
      read -r MYSQL_HOST
      echo "ğŸ“ Enter MySQL port (default 3306):"
      read -r MYSQL_PORT
      MYSQL_PORT=${MYSQL_PORT:-3306}
      ;;
  esac

  echo "ğŸ”‘ Setting MySQL credentials for login-path: $LOGIN_PATH"

  mysql_config_editor set \
    --login-path="$LOGIN_PATH" \
    --host="$MYSQL_HOST" \
    --user="$MYSQL_USER" \
    --port="$MYSQL_PORT" \
    --password

  chmod 600 "$HOME/.mylogin.cnf"
  echo "âœ… MySQL login path [$LOGIN_PATH] configured and secured."
else
  echo "â„¹ï¸ Skipping MySQL login path configuration."
fi
