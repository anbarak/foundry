#!/usr/bin/env bash
set -euo pipefail

# Trap CTRL+C to cleanly exit
trap "echo -e '\nâŒ Setup cancelled.'; exit 130" INT

# Warn if not inside tmux
if [ -z "${TMUX-}" ]; then
  echo "âš ï¸  Not inside a tmux session. It's recommended to run setup inside tmux."
else
  echo "âœ… Inside tmux session."
fi

# Check if 'gum' is installed
if ! command -v gum &>/dev/null; then
  echo "âŒ 'gum' is not installed. Please run: brew install gum"
  exit 1
fi

# âœ… Recommend full bootstrap if user hasn't run it yet
if [[ -f ~/bin/bootstrap/init-machine ]]; then
  echo "â„¹ï¸  If this is a new machine, consider running '~/bin/bootstrap/init-machine' first."
fi

# Interactive menu
choice=$(gum choose \
  "ğŸ›   Run Full Restore" \
  "ğŸ”  Restore Secrets Only" \
  "ğŸ“¤  Backup Secrets to Bitwarden" \
  "ğŸ¨  Setup Terminal Theme (Font + Theme)" \
  "ğŸ”  Finalize Setup (plugins, completions)" \
  "ğŸ“¦  Lint Dotfiles" \
  "âŒ  Exit")

# Helper function to run scripts safely
run_script() {
  local script_path="$1"
  if [[ -x "$script_path" ]]; then
    "$script_path"
  else
    echo "âŒ Script not found or not executable: $script_path"
    exit 1
  fi
}

# Handle the choice
case "$choice" in
  "ğŸ›   Run Full Restore")       run_script ~/bin/dev-env/full-restore ;;
  "ğŸ”  Restore Secrets Only")   run_script ~/bin/tools/secrets/secrets-backup-task.sh ;;
  "ğŸ“¤  Backup Secrets to Bitwarden")  run_script ~/bin/tools/secrets/secrets-restore-task.sh ;;
  "ğŸ¨  Setup Terminal Theme (Font + Theme)") run_script ~/bin/bootstrap/setup-terminal-theme ;;
  "ğŸ”  Finalize Setup (plugins, completions)") run_script ~/bin/dev-env/finalize ;;
  "ğŸ“¦  Lint Dotfiles")          run_script ~/bin/dev-env/lint-dotfiles ;;
  "âŒ  Exit")                   echo "Bye ğŸ‘‹"; exit 0 ;;
esac
