#!/usr/bin/env bash
set -euo pipefail

# Log setup (cron-friendly + interactive)
LOG_FILE="$HOME/backup/secret_backup_logs/backup.log"
mkdir -p "$(dirname "$LOG_FILE")"
exec > >(tee -a "$LOG_FILE") 2>&1
echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') Starting secrets backup..."

# Wrap the backup process to track success/failure
run_backup() {
  echo "üì¶ Creating secrets backup..."

  # Define secrets to archive
  timestamp=$(date +"%Y%m%d-%H%M%S")
  backup_file="$HOME/sensitive_config_files-$timestamp.tar.gz"
  cd "$HOME"

  tar --exclude='.kube/cache' \
      --exclude='.aws/sso/cache' \
      --exclude='.aws/cli/cache' \
      --exclude='.gnupg/S.*' \
      --exclude='.gnupg/.gpg-connect_history' \
      --exclude='.gnupg/random_seed' \
      --exclude='.gnupg/private-keys-v1.d' \
      --exclude='.DS_Store' \
      --exclude='.ssh/known_hosts' \
      --exclude='*.lock' --exclude='*.tmp' --exclude='*.bak' \
      --exclude='*.[oO][lL][dD]*' \
      -czf "$backup_file" \
      .ssh .aws .saml2aws .kube .gnupg .vpn-configs \
      .gitconfig .gitconfig-centerfield

  echo "üîê Uploading to Bitwarden..."

  # Bitwarden login
  BW_MASTER_PASSWORD=$(security find-generic-password -s bitwarden -a master-password -w 2>/dev/null || true)

  if [[ -z "$BW_MASTER_PASSWORD" ]]; then
    echo "‚ùå Bitwarden master password not found in Keychain. Please run:"
    echo "$HOME/bin/tools/setup/save-bitwarden-master-password-to-keychain.sh"
    return 1
  fi

  BW_SESSION=$(echo "$BW_MASTER_PASSWORD" | bw unlock --raw)
  export BW_SESSION

  bw sync

  item_id=$(bw list items --search "Sensitive Config Files Backup" --session "$BW_SESSION" | jq -r '.[0].id')

  # Create item if missing
  if [[ -z "$item_id" || "$item_id" == "null" ]]; then
    folder_id=$(bw list folders --session "$BW_SESSION" | jq -r '.[] | select(.name=="Personal-work") | .id')
    item_id=$(bw get template item | \
      jq --arg name "Sensitive Config Files Backup" \
         --arg notes "Backup created on $(hostname) at $(date +'%Y-%m-%d %H:%M:%S %Z')" \
         --arg folder_id "$folder_id" \
         --arg upload_date "$(date +'%Y-%m-%d %H:%M:%S %Z')" \
         --arg archive_size "$(du -h "$backup_file" | cut -f1)" \
         --arg device "$(hostname)" \
      '.
        | .type = 2
        | .secureNote.type = 0
        | .name = $name
        | .notes = $notes
        | .folderId = $folder_id
        | .fields = [
            {name: "last-upload-date", value: $upload_date, type: 0},
            {name: "archive-size", value: $archive_size, type: 0},
            {name: "device", value: $device, type: 0}
          ]' | \
      bw encode | \
      bw create item --session "$BW_SESSION" | jq -r '.id')
  fi

  # Re-upload, keeping only the 3 most recent attachments
  echo "üßº Checking for previous attachments to remove..."
  bw get item "$item_id" --session "$BW_SESSION" | \
    jq -r '.attachments | sort_by(.fileName) | reverse | .[3:][]?.id' | \
    while read -r old_id; do
      echo "üóëÔ∏è  Removing old attachment ID: $old_id"
      bw delete attachment "$old_id" --itemid "$item_id" --session "$BW_SESSION"
    done

  bw create attachment --file "$backup_file" --itemid "$item_id" --session "$BW_SESSION"

  # Show backup location
  attachment_url=$(bw get item "$item_id" --session "$BW_SESSION" | jq -r '.attachments[0].url // "N/A"')
  echo "‚úÖ Backup uploaded and saved in Bitwarden."
  echo "üìÅ Item: Sensitive Config Files Backup"
  echo "üåê URL: $attachment_url"
  echo "üóÉÔ∏è  Folder: Personal-work"

  # Clean up local archive
  echo "üßπ Cleaning up local backup..."
  rm -f "$backup_file"
}

# Run and report result
if run_backup; then
  osascript -e 'display notification "‚úÖ Secrets backup completed." with title "Bitwarden Backup"'
  echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') Script exited with code: 0"
  exit 0
else
  osascript -e 'display notification "‚ùå Secrets backup failed!" with title "Bitwarden Backup" sound name "Funk"'
  echo "[ERROR] $(date +'%Y-%m-%d %H:%M:%S') Script failed with code: $?"
  exit 1
fi
