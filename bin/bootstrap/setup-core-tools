#!/usr/bin/env bash
set -euo pipefail

# --------------------------------------------------------------------
# Setup whisper.cpp models
# --------------------------------------------------------------------
echo "üß† Setting up Whisper.cpp models..."

WHISPER_MODEL_DIR="$HOME/.local/share/whisper/models"
mkdir -p "$WHISPER_MODEL_DIR"

WHISPER_MODELS=(
  "ggml-base.en.bin"         # English-only (small)
  "ggml-medium.en.bin"       # English-only (medium)
  "ggml-large-v3.bin"        # Multilingual (best accuracy)
  "ggml-base.bin"            # Multilingual (small)
  "ggml-medium.bin"          # Multilingual (medium)
)

for MODEL in "${WHISPER_MODELS[@]}"; do
  MODEL_PATH="$WHISPER_MODEL_DIR/$MODEL"
  if [[ ! -f "$MODEL_PATH" ]]; then
    echo "‚¨áÔ∏è  Downloading $MODEL ..."
    curl -Ls -o "$MODEL_PATH" "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/$MODEL"
  else
    echo "‚úÖ $MODEL already exists."
  fi
done

echo "‚úÖ Whisper.cpp setup complete."

# --------------------------------------------------------------------
# Setup Shottr (screenshot tool)
# --------------------------------------------------------------------
echo "üì∏ Setting up Shottr..."

if ! brew list --cask -1 | grep -qx shottr; then
  echo "üì¶ Installing Shottr..."
  brew install --cask shottr
else
  echo "‚úÖ Shottr already installed."
fi

SHOTTR_CONFIG_SRC="$HOME/.config/shottr/cc.ffitch.shottr.plist"
SHOTTR_CONFIG_DEST="$HOME/Library/Containers/cc.ffitch.shottr/Data/Library/Preferences/cc.ffitch.shottr.plist"

if [[ -f "$SHOTTR_CONFIG_SRC" ]]; then
  if [[ -d "$(dirname "$SHOTTR_CONFIG_DEST")" ]]; then
    echo "‚ôªÔ∏è  Restoring Shottr preferences..."
    cp "$SHOTTR_CONFIG_SRC" "$SHOTTR_CONFIG_DEST"
    killall cfprefsd &>/dev/null || echo "‚ÑπÔ∏è  Could not kill cfprefsd ‚Äî it may not be running."
    echo "‚úÖ Shottr preferences restored."
  else
    echo "‚ö†Ô∏è  Shottr must be launched at least once before restoring preferences."
  fi
else
  echo "‚ö†Ô∏è  Shottr preferences not found at:"
  echo "   $SHOTTR_CONFIG_SRC"
  echo "üìñ To configure manually, see:"
  echo "   ~/.config/shottr/shottr-config.md"
fi

echo "‚úÖ Shottr setup complete."
