#!/usr/bin/env bash
set -euo pipefail

echo "‚öôÔ∏è Initializing dev machine..."

# -----------------------------------------------------------------------------
# Step 1: Install Homebrew and core CLI tools via Brewfile
# -----------------------------------------------------------------------------
if ! command -v brew &>/dev/null; then
  echo "üõ†Ô∏è Homebrew not found ‚Äî installing..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
else
  echo "üç∫ Homebrew already installed."
fi

echo "üì¶ Updating Homebrew..."
brew update

BREWFILE="$HOME/.config/homebrew/Brewfile"
if [[ -f "$BREWFILE" ]]; then
  echo "üì¶ Installing packages from Brewfile..."
  brew bundle --file="$BREWFILE"
else
  echo "‚ö†Ô∏è Brewfile not found at $BREWFILE"
fi

# -----------------------------------------------------------------------------
# Step 2: Create dotfiles structure
# -----------------------------------------------------------------------------
echo "üìÅ Setting up dotfiles structure..."
[ -f "$HOME/.zshrc.local" ] || touch "$HOME/.zshrc.local"
mkdir -p "$HOME/.config/zsh/modules"
mkdir -p "$HOME/bin"

if [[ ! -L "$HOME/bin/ycommit" ]]; then
  echo "üîó Linking ycommit command..."
  ln -sf "$HOME/bin/git/yadm-commit" "$HOME/bin/ycommit"
fi

# -----------------------------------------------------------------------------
# Step 2b: Create code directory structure
# -----------------------------------------------------------------------------
echo "üìÅ Creating code folders (cf, my, tmp)..."
mkdir -p "$HOME/code/cf" "$HOME/code/my" "$HOME/code/tmp"

# -----------------------------------------------------------------------------
# Step 3: Modular setup scripts (cloud/dev tools)
# -----------------------------------------------------------------------------
SCRIPTS=(
  "$HOME/bin/bootstrap/setup-core-tools"
  "$HOME/bin/bootstrap/setup-terraform-tools"
  "$HOME/bin/bootstrap/setup-kubernetes-tools"
  "$HOME/bin/bootstrap/setup-cloud-core"
)

for script in "${SCRIPTS[@]}"; do
  if [[ -x "$script" ]]; then
    echo "‚û°Ô∏è  Running $(basename "$script")..."
    "$script"
  else
    echo "‚ö†Ô∏è Skipping missing or non-executable: $script"
  fi
done

# ------------------------------------------------------------------------
# Step 4: Install weekly restart reminder (LaunchAgent)
# ------------------------------------------------------------------------
echo "‚è∞ Installing restart reminder LaunchAgent..."

RESTART_INSTALLER="$HOME/bin/tools/system/install-restart-reminder.sh"
if [[ -x "$RESTART_INSTALLER" ]]; then
  "$RESTART_INSTALLER"
else
  echo "‚ö†Ô∏è Skipping restart reminder install ‚Äî script not found or not executable: $RESTART_INSTALLER"
fi

echo "‚úÖ Bootstrap complete."
echo "üí° Tip: Run 'exec zsh' or restart terminal to apply shell changes."
echo "üß™ Tip: Run '~/bin/lint-dotfiles.sh' to validate dotfiles."
