#!/usr/bin/env bash
set -euo pipefail

echo "âš™ï¸ Initializing dev machine..."

# -----------------------------------------------------------------------------
# Install Homebrew and core CLI tools via Brewfile.
# Setup weekly homebrew maintenance (LaunchAgent)
# -----------------------------------------------------------------------------
# Detect OS and set up package manager
# shellcheck source=../foundry/detect-os.sh
source "$HOME/bin/foundry/detect-os.sh"

case "$FOUNDRY_OS" in
  macos)
    if ! command -v brew &>/dev/null; then
      echo "ğŸ› ï¸ Homebrew not found â€” installing..."
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    else
      echo "ğŸº Homebrew already installed."
    fi
    echo "ğŸ“¦ Setting up Homebrew maintenance..."
    "$HOME/bin/tools/system/install-brew-maintenance.sh"
    ;;
  wsl|linux)
    echo "ğŸ§ Detected Linux/WSL - updating package lists..."
    if [[ "$FOUNDRY_PKG_MANAGER" == "apt" ]]; then
      sudo apt-get update
      sudo apt-get install -y \
        build-essential \
        curl \
        git \
        wget \
        unzip
    elif [[ "$FOUNDRY_PKG_MANAGER" == "yum" ]]; then
      sudo yum groupinstall -y "Development Tools"
      sudo yum install -y curl git wget unzip
    fi

    # Check if Homebrew executable exists (not just the directory)
    if [[ ! -x /home/linuxbrew/.linuxbrew/bin/brew ]]; then
      echo "ğŸº Installing Homebrew for Linux..."
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    else
      echo "âœ… Homebrew already installed"
    fi

    # Always ensure Homebrew is in PATH for the current session
    if [[ -x /home/linuxbrew/.linuxbrew/bin/brew ]]; then
      eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    fi
    ;;
esac

# -----------------------------------------------------------------------------
# Install Python Environment Toolchain
# -----------------------------------------------------------------------------
if [[ ! -f "$HOME/.config/python/versions.txt" ]]; then
  echo "ğŸš« Missing python versions.txt â€” skipping Python setup"
else
  # Install pyenv and pipx first via Homebrew (if not already installed)
  if ! command -v pyenv >/dev/null 2>&1; then
    echo "ğŸ“¦ Installing pyenv via Homebrew..."
    brew install pyenv pyenv-virtualenv
  else
    echo "âœ… pyenv already installed"
  fi

  if ! command -v pipx >/dev/null 2>&1; then
    echo "ğŸ“¦ Installing pipx via Homebrew..."
    brew install pipx
    pipx ensurepath
  else
    echo "âœ… pipx already installed"
  fi

  # Now run the Python environment setup
  echo "ğŸ”§ Setting up Python environment..."
  ~/bin/tools/setup/setup-python-env.sh
fi

# -----------------------------------------------------------------------------
# Create dotfiles structure
# -----------------------------------------------------------------------------
echo "ğŸ“ Setting up dotfiles structure..."
[ -f "$HOME/.zshrc.local" ] || touch "$HOME/.zshrc.local"
mkdir -p "$HOME/.config/zsh/modules"
mkdir -p "$HOME/bin"

if [[ ! -L "$HOME/bin/ycommit" ]]; then
  echo "ğŸ”— Linking ycommit command..."
  ln -sf "$HOME/bin/git/yadm-commit" "$HOME/bin/ycommit"
fi

if [[ ! -L "$HOME/bin/open-kdbx" ]]; then
  echo "ğŸ”— Linking open-kdbx command..."
  ln -sf "$HOME/bin/tools/kdbx/open-kdbx.sh" "$HOME/bin/open-kdbx"
fi

# -----------------------------------------------------------------------------
# Create code directory structure
# -----------------------------------------------------------------------------
echo "ğŸ“ Creating code folders (cf, my, tmp)..."
mkdir -p "$HOME/code/cf" "$HOME/code/my" "$HOME/code/tmp"

# -----------------------------------------------------------------------------
# Modular setup scripts (cloud/dev tools)
# -----------------------------------------------------------------------------
SCRIPTS=(
  "$HOME/bin/bootstrap/setup-core-tools"
  "$HOME/bin/bootstrap/setup-terraform-tools"
  "$HOME/bin/bootstrap/setup-kubernetes-tools"
  "$HOME/bin/bootstrap/setup-cloud-core"
)

for script in "${SCRIPTS[@]}"; do
  if [[ -x "$script" ]]; then
    echo "â¡ï¸  Running $(basename "$script")..."
    "$script"
  else
    echo "âš ï¸ Skipping missing or non-executable: $script"
  fi
done

# -----------------------------------------------------------------------------
# Configure Colima (docker desktop replacement)
# -----------------------------------------------------------------------------
echo "â–¶ï¸  Initializing Colima with default profile (aarch64)..."
~/.colima/default/colima.yaml
# Only set config if Colima is not already configured
if [ ! -f "$HOME/.colima/default/colima.yaml" ]; then
  colima start --arch aarch64 --cpu 2 --memory 2 --disk 20 --vm-type vz --save-config
  colima stop
fi

# -----------------------------------------------------------------------------
# Setup AI tools
# -----------------------------------------------------------------------------
echo "ğŸ§  Installing AI tools..."
if [[ -x "$HOME/bin/tools/ai/setup-ai-tools.sh" ]]; then
  "$HOME/bin/tools/ai/setup-ai-tools.sh"
else
  echo "âš ï¸  Skipping AI tools intallation â€” script not found or not executable"
fi

# -----------------------------------------------------------------------------
# Check if xbar is running and display a helpful message
# -----------------------------------------------------------------------------
if ! pgrep -f "xbar.app" >/dev/null; then
  echo "âš ï¸  xbar is not currently running. You can launch it via Spotlight or Applications folder."
else
  echo "âœ… xbar is already running."
fi

# -----------------------------------------------------------------------------
# Setup secrets backup (LaunchAgent)
# -----------------------------------------------------------------------------
SECRETS_BACKUP_INSTALLER="$HOME/bin/tools/system/install-secrets-backup.sh"
if [[ -x "$SECRETS_BACKUP_INSTALLER" ]]; then
  "$SECRETS_BACKUP_INSTALLER"
else
  echo "âš ï¸  Skipping secrets backup LaunchAgent â€” script not found or not executable"
fi

# -----------------------------------------------------------------------------
# Install librespeed-cli (speed test utility)
# -----------------------------------------------------------------------------
echo "ğŸ“¡ Installing librespeed-cli..."
if [[ ! -x "$HOME/.local/bin/tools/librespeed-cli" ]]; then
  "$HOME/bin/tools/system/setup-librespeed.sh"
fi

# ------------------------------------------------------------------------
# Install weekly restart reminder (LaunchAgent)
# ------------------------------------------------------------------------
echo "â° Installing restart reminder LaunchAgent..."

RESTART_INSTALLER="$HOME/bin/tools/system/install-restart-reminder.sh"
if [[ -x "$RESTART_INSTALLER" ]]; then
  "$RESTART_INSTALLER"
else
  echo "âš ï¸ Skipping restart reminder install â€” script not found or not executable: $RESTART_INSTALLER"
fi

# ------------------------------------------------------------------------------
# Secure credentials setup (interactive, one-time per machine)
# ------------------------------------------------------------------------------
echo "ğŸ” Checking for Bitwarden master password in Keychain..."

if ! security find-generic-password -s bitwarden -a master-password -w &>/dev/null; then
  echo "âš ï¸ Bitwarden master password not found in Keychain."
  echo "ğŸ‘‰ Running setup to save it now..."
  "$HOME/bin/tools/setup/save-bitwarden-master-password-to-keychain.sh"
else
  echo "âœ… Bitwarden master password is already in Keychain."
fi

# --------------------------------------------------------------------
# Restore internal /etc/hosts mappings (e.g., Jenkins agents)
# --------------------------------------------------------------------
echo "ğŸ“ Applying custom hosts block to /etc/hosts..."
"$HOME/bin/tools/system/apply-hosts-block.sh" || echo "âš ï¸ Failed to apply /etc/hosts block"

# ------------------------------------------------------------------------------
# Set up permissions and test secrets-related tools
# ------------------------------------------------------------------------------
echo "ğŸ” Validating secrets and ssh audit tooling..."

mkdir -p "$HOME/bin/tools/ssh"
mkdir -p "$HOME/bin/tools/backup"

chmod +x "$HOME/bin/tools/ssh/lint-config.sh" \
         "$HOME/bin/tools/ssh/audit-keys.sh" \
         "$HOME/bin/tools/backup/check-bitwarden.sh" 2>/dev/null || true

# ------------------------------------------------------------------------------
# Optional: Set system DNS to public resolvers (Cloudflare + Google)
# ------------------------------------------------------------------------------
read -rp "ğŸŒ Set DNS to Cloudflare (1.1.1.1) + Google (8.8.8.8)? [y/N] " dns_choice
if [[ "$dns_choice" =~ ^[Yy]$ ]]; then
  "$FOUNDROOT/tools/networking/set-dns-public.sh"
else
  echo "â Skipping DNS configuration."
fi

# Run validation scripts
"$HOME/bin/tools/ssh/lint-config.sh" || echo "âš ï¸ SSH config lint failed"
"$HOME/bin/tools/ssh/audit-keys.sh" || echo "âš ï¸ SSH key audit failed"
"$HOME/bin/tools/backup/check-bitwarden.sh" || echo "âš ï¸ Bitwarden CLI session check failed"

echo "âœ… Bootstrap complete."
echo "ğŸ’¡ Tip: Run 'exec zsh' or restart terminal to apply shell changes."
echo "ğŸ§ª Tip: Run '~/bin/lint-dotfiles.sh' to validate dotfiles."
